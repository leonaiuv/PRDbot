name: PR æµ‹è¯•æ£€æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-validation:
    name: PR æµ‹è¯•éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: prd-generator/package-lock.json
      
      - name: å®‰è£…ä¾èµ–
        working-directory: prd-generator
        run: npm ci
      
      - name: è¿è¡Œæµ‹è¯•
        working-directory: prd-generator
        run: npm run test:ci
      
      - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
        working-directory: prd-generator
        run: |
          echo "æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ° 80% é˜ˆå€¼..."
          if [ -f coverage/coverage-summary.json ]; then
            echo "## è¦†ç›–ç‡æŠ¥å‘Š ğŸ“Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å„æ¨¡å—è¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | jq '.total' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æµ‹è¯•æ–‡ä»¶
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.test\.(ts|tsx)$' || true)
          if [ -n "$FILES" ]; then
            echo "## âœ… æ£€æµ‹åˆ°æ–°å¢æµ‹è¯•æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: è¯„è®º PRï¼ˆå¦‚æœæµ‹è¯•å¤±è´¥ï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤åå†æäº¤ã€‚\n\nè¿è¡Œ `npm test` æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚'
            })
