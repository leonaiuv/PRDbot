# 测试基础设施

<cite>
**本文档引用的文件**  
- [jest.config.js](file://prd-generator/jest.config.js)
- [jest.setup.js](file://prd-generator/jest.setup.js)
- [package.json](file://prd-generator/package.json)
- [tsconfig.json](file://prd-generator/tsconfig.json)
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md)
</cite>

## 目录
1. [简介](#简介)
2. [测试配置与环境](#测试配置与环境)
3. [核心测试模块](#核心测试模块)
4. [测试工具与辅助函数](#测试工具与辅助函数)
5. [技术挑战与解决方案](#技术挑战与解决方案)
6. [测试覆盖率分析](#测试覆盖率分析)
7. [未完成的测试模块](#未完成的测试模块)
8. [下一步建议](#下一步建议)
9. [测试命令](#测试命令)
10. [成果总结](#成果总结)

## 简介
本项目 `prd-generator` 是一个基于 Next.js 的 PRD（产品需求文档）生成器，具备完整的前端界面和本地数据持久化能力。其测试基础设施围绕核心业务逻辑构建，重点覆盖数据持久化层、状态管理层、工具函数等关键模块。

根据 `TEST_SUMMARY.md` 文档，当前测试体系已实现 87 个测试用例全部通过，通过率达 100%，为项目核心功能提供了坚实的质量保障。本文档将系统性地分析该项目的测试基础设施，包括配置、结构、覆盖范围及未来规划。

## 测试配置与环境

### Jest 配置
项目使用 Jest 作为核心测试框架，并通过 `next/jest` 适配器与 Next.js 项目无缝集成。主要配置如下：

- **测试环境**: `jest-environment-jsdom`，模拟浏览器环境，适用于 React 组件和 DOM 操作测试。
- **模块映射**: 配置了路径别名 `@/*` 映射到 `src/*`，确保导入语句在测试环境中正常解析。
- **UUID 模块处理**: 由于 `uuid` 库使用 ESM 格式，Jest 默认不转换 `node_modules`，因此通过 `moduleNameMapper` 将 `uuid` 模块映射到自定义的 mock 文件 `src/__tests__/__mocks__/uuid.js`，避免语法错误。
- **测试文件匹配**: 支持多种命名模式，如 `**/__tests__/**/*.test.[jt]s?(x)` 和 `**/?(*.)+(spec|test).[jt]s?(x)`。
- **覆盖率报告**: 配置了严格的覆盖率阈值（分支、函数、行数、语句均需达到 80%），并生成文本、lcov 和 HTML 格式的报告。

**Section sources**
- [jest.config.js](file://prd-generator/jest.config.js#L1-L43)

### 测试环境 Polyfills
`jest.setup.js` 文件负责在测试环境启动时进行必要的全局配置和 polyfill，解决 Node.js 环境与浏览器环境的差异。

- **Web API Polyfill**:
  - `TextEncoder`/`TextDecoder`: 从 Node.js 的 `util` 模块导入并挂载到全局对象。
  - `ReadableStream`: 从 `stream/web` 导入并挂载到全局对象，支持流式响应测试。
  - `structuredClone`: 为 Node.js < 17 的版本提供 polyfill，使用 `JSON.parse(JSON.stringify())` 模拟。
- **浏览器 API Mock**:
  - `window.matchMedia`: 模拟媒体查询，返回固定的 `matches: false`。
  - `IntersectionObserver` 和 `ResizeObserver`: 提供空实现的类，避免因缺少这些 API 而导致测试失败。
- **控制台日志过滤**: 在测试中抑制特定的已知警告信息，如 `ReactDOM.render` 相关的警告，使测试输出更清晰。

**Section sources**
- [jest.setup.js](file://prd-generator/jest.setup.js#L1-L72)

## 核心测试模块

### 数据持久化层测试
该模块是测试体系中最庞大的部分，共 53 个测试用例，验证了基于 Dexie.js 的 IndexedDB 数据库操作的正确性和鲁棒性。

- **测试范围**:
  - `projectsDB`: 项目 CRUD 操作、搜索功能（大小写不敏感、多字段匹配）。
  - `settingsDB`: API 密钥的 AES 加密存储、默认设置的创建。
  - `chatDraftsDB`: 聊天草稿的保存、删除及基于时间戳的过期自动清理。
  - `prdTasksDB`: PRD 生成任务的持久化、状态恢复、已完成任务的清理。
- **关键验证点**:
  - **数据完整性**: 验证必填字段、时间戳（`createdAt`, `updatedAt`）的一致性。
  - **加密安全性**: 验证加密解密流程的正确性，并测试重复加密防护机制。
  - **时间逻辑**: 通过直接操作数据库（绕过 `save` 方法）精确控制时间戳，验证 `cleanup` 操作的准确性。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L13-L27)

### 状态管理层测试
项目使用 Zustand 进行状态管理，该模块的 34 个测试用例确保了应用状态的原子性、一致性和可预测性。

- **测试范围**:
  - `useProjectStore`: 派生状态（如 `getCurrentProject`）的一致性、原子性更新、项目生命周期管理。
  - `useSettingsStore`: 设置的持久化、API 密钥的管理。
  - `useChatStore`: 状态按项目隔离、`AbortController` 的正确管理以中断流式请求。
  - `usePRDGenerationStore`: 使用 `chunks` 数组优化流式内容性能、任务生命周期、中断后恢复机制。
- **关键验证点**:
  - **派生状态**: 验证 `getCurrentProject` 是否能从 `projects` 数组中正确派生。
  - **原子性**: 验证 `addMessage`、`updatePRDContent` 等操作是否为原子更新。
  - **隔离性**: 验证不同项目的生成状态互不影响。
  - **性能优化**: 验证流式内容是否被正确分割到 `chunks` 数组中。
  - **中断处理**: 验证 `AbortController` 能否正确中断请求并清理资源。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L28-L43)

### 工具函数测试
对 `src/lib` 目录下的核心工具函数进行了全面的单元测试。

- **加密工具 (`crypto.ts`)**:
  - 基本的加密/解密功能。
  - 特殊字符和 Unicode 的处理。
  - API 密钥对象的批量加密。
  - `isEncrypted` 检测函数。
  - 重复加密防护。
  - 错误处理（无效密文、空输入）。
- **校验工具 (`validator.ts`)**:
  - `extractJSON`: 从 AI 的各种响应格式（代码块、裸 JSON、嵌入 JSON）中提取 JSON 数据。
  - `validateAIResponse`: 使用 Zod schema 校验 AI 响应的结构（问题数量、选项数量、枚举类型）。
  - `buildRetryPrompt`: 生成重试提示词。
  - `checkCompleteness`: 检查 AI 推荐选项的完整性。
  - `aggregateSSEStream`: 聚合服务器发送事件（SSE）的流式响应。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L44-L64)

## 测试工具与辅助函数
项目建立了一套完善的测试辅助工具，提高了测试代码的可维护性和可读性。

- **数据工厂函数 (`src/__tests__/utils/factories.ts`)**:
  - 提供了一系列函数来创建符合业务逻辑的测试数据对象，如 `createTestProject()`、`createTestSettings()`、`createTestMessage()` 等。这确保了测试数据的一致性和真实性。
- **测试辅助函数 (`src/__tests__/utils/helpers.ts`)**:
  - `clearTestDatabase()`: 在测试前后清空测试数据库，保证测试的独立性。
  - `waitFor()`: 等待异步操作完成。
  - `isValidTimestamp()` 和 `isValidUUID()`: 用于验证生成的数据是否符合预期格式。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L98-L113)

## 技术挑战与解决方案
在构建测试基础设施的过程中，团队克服了多个技术难点。

### UUID 模块的 ESM 兼容性问题
**问题**: `uuid` 库使用 ES 模块（ESM）语法（`export`），而 Jest 在处理 `node_modules` 时默认不进行转换，导致 `SyntaxError: Unexpected token 'export'`。

**解决方案**: 创建一个自定义的 CommonJS 格式的 mock 文件 `src/__tests__/__mocks__/uuid.js`，并在 `jest.config.js` 中通过 `moduleNameMapper` 将 `uuid` 模块指向这个 mock 文件。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L118-L133)

### Node.js 环境缺失 Web API
**问题**: `TextEncoder`、`ReadableStream`、`structuredClone` 等现代 Web API 在 Node.js 环境中不可用，而项目代码依赖这些 API。

**解决方案**: 在 `jest.setup.js` 中导入 Node.js 提供的 polyfill 并挂载到全局对象 `global` 上，使测试环境能模拟浏览器行为。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L135-L148)

### 数据库清理测试的时间戳问题
**问题**: 数据库的 `save` 方法在保存时会自动更新 `updatedAt` 字段，使得无法手动设置一个“过期”的旧时间戳来测试 `cleanup` 功能。

**解决方案**: 绕过 `save` 方法，直接使用 Dexie 的底层 `put` 方法，这样可以精确控制 `updatedAt` 字段的值，从而验证基于时间的清理逻辑。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L150-L161)

### PRD 生成状态的 elapsedTime 测试
**问题**: `updateElapsedTime` 函数只在生成阶段（`phase` 为 `'generating'`）时才更新耗时，普通的状态设置无法触发此逻辑。

**解决方案**: 使用 Zustand store 的 `setState` 方法直接修改 store 的内部状态，手动将 `phase` 设置为 `'generating'` 并设置一个过去的 `startTime`，从而触发 `elapsedTime` 的计算逻辑。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L163-L178)

## 测试覆盖率分析
当前的测试体系已实现了对核心模块的 100% 覆盖。

| 模块 | 测试文件 | 测试数量 | 状态 |
| :--- | :--- | :--- | :--- |
| 数据持久化层 | `db.test.ts` | 53 | ✅ 100% |
| 状态管理层 | `index.test.ts` | 34 | ✅ 100% |
| 加密工具 | `crypto.test.ts` | ~15 | ✅ 100% |
| 校验工具 | `validator.test.ts` | ~20 | ✅ 100% |

**测试类型分布**:
- **单元测试**: 87 个，覆盖了工具函数、数据库操作和状态管理。
- **集成测试**: 基础设施已准备就绪，但尚未实施。API 路由和 UI 组件的集成测试有待开发。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L186-L203)

## 未完成的测试模块
尽管核心模块已得到充分测试，但仍有一些重要领域需要补充。

### API 交互层测试
- **待测内容**: `/api/chat` 和 `/api/generate-prd` 两个 API 路由的请求验证、校验流程、重试机制和 SSRF 防护。
- **当前状态**: 骨架代码已创建但被删除，主要原因是需要配置 Next.js API Route 的测试环境（如 Request/Response 对象的 polyfill）。

### UI 组件层测试
- **待测内容**: `SmartSelector`、`GenerationStatusBar`、`GeneratingIndicator` 等复杂 UI 组件的交互逻辑。
- **当前状态**: 建议独立实施，因为需要大量的 UI 组件 mock，且优先级相对较低。

### 业务流程层测试
- **待测内容**: 从项目创建到 PRD 生成的端到端（E2E）完整业务流程。
- **当前状态**: 建议使用 Playwright 等专门的 E2E 测试工具来实施。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L228-L243)

## 下一步建议
为完善测试体系，建议按以下优先级推进：

### 短期任务
1. **完善 API 路由测试**:
   - 配置 Next.js API Route 的测试环境。
   - 使用 MSW (Mock Service Worker) 实现 mock handlers。
   - 完成对 SSRF 防护等安全特性的完整测试。
2. **实施 UI 组件测试**:
   - 配置 shadcn/ui 组件的 mock。
   - 实现 `SmartSelector` 和 `GenerationStatusBar` 的关键交互测试。

### 中期任务
3. **开展集成测试**:
   - 测试项目创建到 PRD 生成的完整流程。
   - 模拟错误恢复场景。
   - 验证跨模块的数据一致性。
4. **实施 E2E 测试**:
   - 使用 Playwright 编写关键用户路径的自动化测试。
   - 覆盖跨浏览器兼容性。

### 长期维护
5. **建立持续集成 (CI)**:
   - 在 GitHub Actions 中配置自动化测试流程。
   - 每次提交时自动运行测试和覆盖率检查。
6. **进行性能测试**:
   - 对 `chunks` 数组等性能关键点进行基准测试。
   - 检测大数据量场景下的内存泄漏。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L246-L283)

## 测试命令
以下是常用的 npm 脚本命令：

```bash
# 运行所有测试
npm test

# 运行特定测试文件
npm test -- db.test.ts

# 运行并生成覆盖率报告
npm test -- --coverage

# 监听模式（文件变化时自动重新运行）
npm test -- --watch

# 详细输出模式
npm test -- --verbose

# CI 环境下运行（使用较少的 worker）
npm test -- --ci --coverage --maxWorkers=2
```

**Section sources**
- [package.json](file://prd-generator/package.json#L10-L13)
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L288-L303)

## 成果总结
该项目的测试基础设施已取得显著成果：

- **量化指标**: 87 个测试用例全部通过，通过率 100%，核心模块（数据层、状态层、工具层）实现 100% 覆盖。
- **质量保证**: 有效验证了数据持久化的完整性、状态管理的原子性、加密的安全性和 AI 响应校验的准确性。
- **技术积累**: 成功解决了 Jest + Next.js 集成、ESM 模块兼容性、IndexedDB 测试和 Zustand 状态管理测试等关键技术难题，为后续开发奠定了坚实基础。

**Section sources**
- [TEST_SUMMARY.md](file://prd-generator/TEST_SUMMARY.md#L308-L326)