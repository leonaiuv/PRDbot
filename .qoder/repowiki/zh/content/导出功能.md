# 导出功能

<cite>
**本文引用的文件**
- [export.ts](file://prd-generator/src/lib/export.ts)
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx)
- [设置页面](file://prd-generator/src/app/settings/page.tsx)
- [项目存储](file://prd-generator/src/store/index.ts)
- [PRD.md 计划文档](file://PRD.md)
- [package.json](file://prd-generator/package.json)
</cite>

## 更新摘要
**变更内容**
- 扩展了导出功能，新增对 PDF 和 Word 格式的支持
- 更新了 `export.ts` 中的 `exportPDF` 和 `exportWord` 实现方式，采用浏览器原生打印和 HTML 转 DOC 兼容格式
- PRD 页面的导出菜单已启用 PDF 和 Word 选项，不再标记为“开发中”
- 设置页面的默认导出格式选择器已支持所有三种格式
- 更新了架构图与流程图以反映多格式导出能力
- 增强了附录中的扩展指引，包含前端与后端实现建议

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录：扩展导出格式指引](#附录扩展导出格式指引)

## 简介
本文件聚焦于“文档导出功能”，系统性说明前端如何将生成的 PRD Markdown 内容导出为文件，以及当前版本对 PDF 和 Word 导出的实现方式。根据 PRD.md 的规划，导出能力已从仅支持 Markdown 前端直出，扩展为支持 Markdown、PDF 和 Word 三种格式。其中，PDF 和 Word 导出通过前端生成兼容格式并触发浏览器下载实现，未来可平滑迁移至后端生成服务。

## 项目结构
导出功能涉及三个层面：
- 前端导出工具：`lib/export.ts` 提供 `exportMarkdown`、`exportPDF` 与 `exportWord` 方法，使用 Blob、`file-saver` 及浏览器打印功能触发下载。
- 页面调用：PRD 页面在用户点击导出时，读取当前项目 PRD 内容并调用相应导出工具。
- 设置与状态：设置页面允许用户配置默认导出格式；项目状态用于标记“已导出”。

```mermaid
graph TB
subgraph "前端"
UI["PRD 页面<br/>导出按钮与格式选择"]
ExportUtil["导出工具<br/>lib/export.ts"]
Store["项目状态存储<br/>store/index.ts"]
Settings["设置页面<br/>默认导出格式"]
end
subgraph "后端计划"
API["导出 API<br/>/api/export/*"]
PDF["PDF 生成服务<br/>puppeteer/marked"]
DOCX["Word 生成服务<br/>docx 库"]
end
UI --> ExportUtil
ExportUtil --> |"触发下载"| Browser["浏览器下载"]
UI --> Store
Settings --> Store
UI -.->|"未来：PDF/Word"| API
API --> PDF
API --> DOCX
```

**图表来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [导出工具](file://prd-generator/src/lib/export.ts#L1-L284)
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)
- [设置页面](file://prd-generator/src/app/settings/page.tsx#L218-L241)
- [PRD.md 计划文档](file://PRD.md#L193-L209)

**章节来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [导出工具](file://prd-generator/src/lib/export.ts#L1-L284)
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)
- [设置页面](file://prd-generator/src/app/settings/page.tsx#L218-L241)
- [PRD.md 计划文档](file://PRD.md#L193-L209)

## 核心组件
- 导出工具 export.ts
  - 提供 `exportMarkdown(content, filename)`：将 Markdown 内容转为 Blob 并触发下载。
  - 提供 `exportPDF(content, filename)`：将 Markdown 转为 HTML，打开新窗口并调用 `print()` 实现 PDF 导出。
  - 提供 `exportWord(content, filename)`：生成包含 Word 兼容标签的 HTML 文件，使用 `.doc` 扩展名导出。
- PRD 页面
  - 导出入口：顶部“导出”下拉菜单，现已启用 Markdown、PDF 和 Word 三种格式。
  - 导出逻辑：校验存在 PRD 内容后调用相应导出函数，并更新项目状态为“已导出”。
- 设置页面
  - 默认导出格式选择：支持 md/pdf/docx，用于设置默认导出行为。
- 项目状态存储
  - `getCurrentProject` 获取当前项目；`setProjectStatus` 更新项目状态（含 exported）。

**章节来源**
- [导出工具](file://prd-generator/src/lib/export.ts#L1-L284)
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [设置页面](file://prd-generator/src/app/settings/page.tsx#L218-L241)
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)

## 架构总览
当前版本的导出流程如下：
- 前端直出（Markdown）：PRD 页面读取当前项目 PRD 内容，调用导出工具生成 Blob 并触发浏览器下载。
- 前端兼容导出（PDF/Word）：用户选择 PDF/Word 后，前端将 PRD Markdown 内容转换为 HTML 格式，通过浏览器打印或文件保存实现导出。

```mermaid
sequenceDiagram
participant U as "用户"
participant UI as "PRD 页面"
participant Util as "导出工具"
participant FS as "浏览器文件系统"
U->>UI : 点击“导出”
UI->>UI : 校验是否存在 PRD 内容
alt 选择 Markdown
UI->>Util : exportMarkdown(内容, 文件名)
Util->>FS : 创建 Blob 并触发下载
else 选择 PDF
UI->>Util : exportPDF(内容, 文件名)
Util->>FS : 打开打印窗口并执行打印
else 选择 Word
UI->>Util : exportWord(内容, 文件名)
Util->>FS : 创建 HTML Blob 并触发下载
end
FS-->>U : 浏览器弹出下载或打印
UI->>UI : 更新项目状态为“已导出”
```

**图表来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [导出工具](file://prd-generator/src/lib/export.ts#L57-L262)

**章节来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [导出工具](file://prd-generator/src/lib/export.ts#L57-L262)

## 详细组件分析

### 组件A：导出工具 export.ts
- 职责
  - 将字符串或对象转换为 Blob 或 HTML 文档，并通过 `file-saver` 或浏览器打印功能触发下载。
- 关键点
  - Markdown 导出：指定 MIME 类型为 `text/markdown`，文件扩展名为 `.md`。
  - PDF 导出：将 Markdown 转为 HTML，打开新窗口并调用 `print()`，用户需手动选择“保存为 PDF”。
  - Word 导出：生成包含 MS Word 兼容标签的 HTML 文件，使用 `application/msword` MIME 类型和 `.doc` 扩展名。
- 复杂度
  - 时间复杂度 O(n)，n 为内容长度；空间复杂度 O(n)。
- 错误处理
  - `exportPDF` 检查打印窗口是否被阻止；其他函数依赖调用方捕获异常。
- 性能
  - 大文本导出会占用内存，建议对超大内容进行分块或提示用户。

```mermaid
flowchart TD
Start(["进入导出函数"]) --> BuildBlob["创建 Blob 或 HTML 内容"]
BuildBlob --> SaveAs["调用 saveAs 或 print 触发下载"]
SaveAs --> End(["结束"])
```

**图表来源**
- [导出工具](file://prd-generator/src/lib/export.ts#L1-L284)

**章节来源**
- [导出工具](file://prd-generator/src/lib/export.ts#L1-L284)

### 组件B：PRD 页面导出入口与流程
- 职责
  - 提供导出按钮与格式选择；现已启用 Markdown、PDF 和 Word 三种格式。
  - 校验 PRD 内容存在性；调用导出工具；更新项目状态为 exported；提示成功。
- 关键点
  - 导出入口位于顶部导航的“导出”下拉菜单。
  - `handleExport(format)` 处理 md、pdf、docx 三种格式。
  - 导出成功后调用 `setProjectStatus('exported')`。

```mermaid
sequenceDiagram
participant U as "用户"
participant UI as "PRD 页面"
participant Store as "项目状态存储"
participant Util as "导出工具"
U->>UI : 点击“导出”
UI->>UI : 校验 PRD 内容
alt 内容存在
UI->>Util : 调用相应导出函数
Util-->>UI : 下载完成
UI->>Store : setProjectStatus("exported")
UI-->>U : 成功提示
else 内容不存在
UI-->>U : 错误提示
end
```

**图表来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)
- [导出工具](file://prd-generator/src/lib/export.ts#L57-L262)

**章节来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)
- [导出工具](file://prd-generator/src/lib/export.ts#L57-L262)

### 组件C：设置页面与默认导出格式
- 职责
  - 提供默认导出格式选择（md/pdf/docx），用于设置默认导出行为。
- 关键点
  - Select 组件绑定 `settings.exportPreferences.defaultFormat`。
  - 该值可用于前端导出时的默认文件名后缀或后续后端导出的默认格式。

**章节来源**
- [设置页面](file://prd-generator/src/app/settings/page.tsx#L218-L241)

### 组件D：项目状态存储
- 职责
  - 管理项目列表、当前项目、状态变更（含 exported）。
- 关键点
  - `getCurrentProject` 派生当前项目；`setProjectStatus` 更新状态并持久化。
  - 导出成功后设置状态为 exported，便于 UI 展示与后续流程。

**章节来源**
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)

## 依赖分析
- 前端依赖
  - file-saver：用于触发浏览器下载。
  - react-markdown/remark-gfm：用于 PRD 内容渲染与编辑。
- 导出工具依赖
  - Blob：构造二进制数据对象。
  - file-saver.saveAs：触发下载。
  - window.print：用于 PDF 导出。
- 设置与状态
  - Zustand：项目状态管理。
- 后端实现（计划）
  - PDF：marked + puppeteer。
  - Word：docx 库。
  - Express 路由：/api/export/pdf 与 /api/export/word。

```mermaid
graph LR
Pkg["package.json 依赖"] --> FS["file-saver"]
Pkg --> RM["react-markdown / remark-gfm"]
ExportTS["lib/export.ts"] --> FS
PRDPage["PRD 页面"] --> ExportTS
PRDPage --> Store["store/index.ts"]
PRDPage --> Settings["settings/page.tsx"]
PRDPlan["PRD.md 计划文档"] --> PDF["PDF 生成服务"]
PRDPlan --> DOCX["Word 生成服务"]
PRDPlan --> API["导出 API 路由"]
```

**图表来源**
- [package.json](file://prd-generator/package.json#L1-L85)
- [导出工具](file://prd-generator/src/lib/export.ts#L1-L284)
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)
- [项目存储](file://prd-generator/src/store/index.ts#L1-L200)
- [设置页面](file://prd-generator/src/app/settings/page.tsx#L218-L241)
- [PRD.md 计划文档](file://PRD.md#L193-L209)

**章节来源**
- [package.json](file://prd-generator/package.json#L1-L85)
- [PRD.md 计划文档](file://PRD.md#L193-L209)

## 性能考虑
- 大内容导出
  - Markdown 和 Word 导出为 Blob 会占用内存，建议对超长 PRD 进行分块或提示用户。
  - PDF 导出涉及新窗口渲染，可能影响性能。
- 下载触发
  - saveAs 由浏览器执行，避免阻塞主线程。
- 后端生成（计划）
  - PDF/Word 生成涉及渲染与序列化，应限制并发与缓存结果，避免重复生成。

[本节为通用建议，不直接分析具体文件]

## 故障排查指南
- 无法下载
  - 检查 PRD 页面是否检测到有效内容；若为空则不会触发导出。
  - 确认浏览器允许弹窗与下载。
- 下载文件名异常
  - 确认传入的文件名参数是否包含非法字符。
- PDF 导出无反应
  - 检查浏览器是否阻止了弹窗；用户需在打印对话框中选择“保存为 PDF”。
- Word 文档格式错乱
  - 由于使用 HTML 兼容格式，复杂排版可能在 Word 中显示异常，建议后端生成正式 .docx 文件。

**章节来源**
- [PRD 页面](file://prd-generator/src/app/project/[id]/prd/page.tsx#L547-L574)

## 结论
- 当前版本：前端直出 Markdown，使用 Blob 与 file-saver 实现一键下载；PDF 和 Word 通过前端生成兼容格式实现，PDF 需用户手动保存，Word 使用 .doc 扩展名。
- 未来版本：后端将提供 PDF/Word 生成服务与 API，前端统一导出入口，用户可按需选择格式，获得更高质量的输出。

[本节为总结，不直接分析具体文件]

## 附录：扩展导出格式指引
- 前端扩展（Markdown/PDF/Word）
  - 在导出工具中新增导出函数，使用 Blob、`saveAs` 或 `print` 触发下载。
  - 在 PRD 页面的导出菜单中添加对应选项，并调用相应导出函数。
- 后端扩展（PDF/Word）
  - PRD.md 提供了后端实现思路：
    - PDF：使用 marked 将 Markdown 转 HTML，再用 puppeteer 渲染为 PDF。
    - Word：使用 docx 库解析 Markdown 并生成 .docx。
  - API 端点：/api/export/pdf 与 /api/export/word，接收 Markdown 内容并返回文件流。
- 集成步骤建议
  - 前端：在导出菜单中启用 PDF/Word 选项，向后端发送 PRD Markdown 内容。
  - 后端：实现 PDF/Word 服务与路由，设置正确的 Content-Type 与 Content-Disposition。
  - UI：导出完成后提示用户并更新项目状态。

**章节来源**
- [PRD.md 计划文档](file://PRD.md#L193-L209)
- [PRD.md 计划文档](file://PRD.md#L681-L799)