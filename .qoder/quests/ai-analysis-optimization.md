# AI分析功能优化设计方案

## 一、背景与现状

### 1.1 功能概述

AI分析功能位于 `ai-analysis-tools.tsx` 组件,通过后端 `/api/analyze` 路由提供四种分析能力:

| 分析类型 | 功能描述 | 预期输出 |
|---------|---------|---------|
| optimize | AI优化建议 | 从多个维度分析PRD并给出结构化改进建议 |
| score | 质量评分 | 对PRD进行100分制专业评分和评级 |
| competitor | 竞品分析 | 识别竞争对手并进行对比分析 |
| diagram | 生成图表 | 生成架构图、流程图、ER图的Mermaid代码 |

### 1.2 核心问题识别

基于代码审查,识别出以下关键问题:

| 优先级 | 问题类型 | 问题描述 | 影响范围 |
|--------|---------|---------|---------|
| P0 | 功能缺陷 | Mermaid图表未实际渲染,仅显示代码块 | 图表功能完全无法使用 |
| P1 | 配置不一致 | analyze API使用qwen-plus/doubao-pro-32k,其他API使用qwen-turbo/doubao-pro-4k | 可能导致请求失败,计费异常 |
| P1 | 错误透传不足 | API错误仅返回状态码,未透传上游详细错误信息 | 问题定位困难 |
| P2 | 测试覆盖缺失 | 无端到端测试,无法验证完整流程 | 回归风险高 |

---

## 二、问题深度分析

### 2.1 问题1: Mermaid图表未渲染 [P0]

#### 问题定位

**前端渲染路径:**
- 文件: `ai-analysis-tools.tsx` 第218-221行
- 当前实现: 使用 `react-markdown` + `remark-gfm` 插件直接渲染
- 根本原因: `react-markdown` 仅支持GitHub Flavored Markdown,不支持Mermaid语法扩展

**后端提示词配置:**
- 文件: `route.ts` 第197-224行
- AI被明确要求返回包含Mermaid代码块的Markdown文本
- 实际响应格式: ` ```mermaid ... ``` `

#### 用户体验落差

| 用户预期 | 实际呈现 | 体验评级 |
|---------|---------|---------|
| 可视化架构图 | 纯文本代码块 | 严重不符 |
| 流程图交互展示 | Mermaid语法代码 | 完全失效 |
| ER图关系可视化 | 文本描述 | 功能缺失 |

#### 边界情况分析

| 场景 | 理想行为 | 当前行为 | 处理策略 |
|------|---------|---------|---------|
| AI返回合法Mermaid语法 | 渲染为交互式图表 | 显示代码块 | 需接入渲染引擎 |
| AI返回语法错误的Mermaid | 降级显示代码并提示错误 | 显示错误代码 | 需错误捕获机制 |
| AI返回多个图表 | 分别渲染多个图表 | 显示多个代码块 | 需批量处理 |
| Mermaid包含中文节点 | 正确渲染中文标签 | 代码块可见 | 需配置字体支持 |
| 图表复杂度超限 | 降级或分页展示 | 显示完整代码 | 需性能保护 |

---

### 2.2 问题2: 模型名称配置不一致 [P1]

#### 配置差异矩阵

| Provider | analyze API | chat API | generate-prd API | 测试期望 |
|----------|-------------|----------|------------------|---------|
| deepseek | deepseek-chat | deepseek-chat | deepseek-chat | deepseek-chat |
| qwen | **qwen-plus** | qwen-turbo | qwen-turbo | qwen-turbo |
| doubao | **doubao-pro-32k** | doubao-pro-4k | doubao-pro-4k | doubao-pro-4k |

#### 风险评估

| 风险类型 | 具体影响 | 严重程度 |
|---------|---------|---------|
| 计费差异 | qwen-plus单价高于qwen-turbo,用户可能超预期消费 | 中 |
| 可用性风险 | 若账号仅开通基础模型,qwen-plus请求会返回403/404 | 高 |
| 上下文窗口 | doubao-pro-32k vs 4k的token限制差异8倍,可能导致超限 | 中 |
| 测试失效 | 测试用例验证qwen-turbo,但实际运行qwen-plus,覆盖无效 | 低 |

#### 不一致场景分析

| 场景 | 预期行为 | 实际行为 | 用户影响 |
|------|---------|---------|---------|
| 用户账号仅开通qwen-turbo | 所有功能正常工作 | analyze功能请求失败 | 功能不可用 |
| 用户使用doubao-pro-4k套餐 | 一致体验 | analyze调用32k模型失败 | 请求报错 |
| 多功能交叉使用 | 行为一致性 | 不同功能调用不同模型 | 困惑 |

---

### 2.3 问题3: 错误信息透传不足 [P1]

#### 当前错误处理流程

```
上游AI API错误
  ↓
后端读取errorText (仅记录日志)
  ↓
返回 "API请求失败: {status}"
  ↓
前端toast显示 "分析失败"
```

**信息丢失路径:**
- 文件: `route.ts` 第287-293行
- 上游返回的详细错误信息(JSON格式)被截断
- 前端仅收到HTTP状态码,无法区分具体错误类型

#### 上游错误类型映射

| 错误类型 | 典型响应 | HTTP状态码 | 当前返回 | 理想返回 |
|---------|---------|-----------|---------|---------|
| API Key无效 | `{"error":{"message":"invalid api key"}}` | 401 | API请求失败: 401 | 认证失败,请检查API Key |
| 模型不存在 | `{"error":{"message":"model not found"}}` | 404 | API请求失败: 404 | 模型不可用,请检查配置 |
| 配额超限 | `{"error":{"message":"quota exceeded"}}` | 429 | API请求失败: 429 | 请求过于频繁,请稍后重试 |
| 账户欠费 | `{"error":{"message":"insufficient balance"}}` | 402 | API请求失败: 402 | 账户余额不足 |
| 请求体格式错误 | `{"error":{"message":"invalid request"}}` | 400 | API请求失败: 400 | 请求格式错误 |

#### 边界情况分析

| 场景 | 理想行为 | 当前行为 | 可诊断性 |
|------|---------|---------|---------|
| API Key过期 | 明确提示"密钥已过期,请更新" | "分析失败" | 低 |
| 网络超时 | 提示"网络超时,请重试" | "分析失败" | 低 |
| 上游限流 | 提示"请求过于频繁,建议X秒后重试" | "API请求失败: 429" | 中 |
| 非JSON错误响应 | 截取前200字符展示 | 仅状态码 | 低 |
| 自定义API白名单拒绝 | 明确提示白名单域名 | "不在允许的API域名白名单中" | 高 |

---

### 2.4 问题4: 端到端测试缺失 [P2]

#### 当前测试覆盖

| 测试维度 | 应覆盖范围 | 当前状态 | 缺失内容 |
|---------|-----------|---------|---------|
| API路由测试 | analyze/chat/generate-prd完整流程 | ❌ 未覆盖 | 所有API端到端测试 |
| 前端组件测试 | ai-analysis-tools状态流转 | ❌ 未覆盖 | loading/success/error状态 |
| 集成测试 | 前后端协作完整链路 | ❌ 未覆盖 | Mock AI响应到UI渲染 |
| Mermaid渲染测试 | 图表正确渲染验证 | ❌ 未覆盖 | 渲染成功/失败分支 |
| 错误处理测试 | 各类错误场景覆盖 | ❌ 未覆盖 | 401/403/404/429场景 |

#### 测试需求矩阵

| 测试类型 | 测试目标 | 验证点 |
|---------|---------|-------|
| API单元测试 | analyze路由各分析类型 | optimize/score/competitor/diagram正确返回 |
| API错误测试 | 错误处理完整性 | 状态码正确,错误信息准确,降级策略有效 |
| 前端组件测试 | 用户交互流程 | 点击分析→loading→结果展示→错误提示 |
| Mermaid渲染测试 | 图表渲染正确性 | 合法语法渲染成功,非法语法降级处理 |
| 模型配置测试 | 配置一致性 | 所有API使用相同模型映射 |
| 白名单测试 | SSRF防护有效性 | 允许域名通过,内网地址拒绝 |

---

## 三、优化方案设计

### 3.1 方案A: Mermaid图表渲染 [P0]

#### 方案选型

| 方案 | 实现方式 | 优势 | 劣势 | 推荐度 |
|------|---------|------|------|-------|
| 方案A1 | 接入mermaid.js库 | 完整支持Mermaid语法,可交互,支持导出 | 需新增依赖,bundle增加约200KB | ⭐⭐⭐⭐⭐ |
| 方案A2 | 使用react-mermaid组件 | 开箱即用,封装完善 | 额外封装层,更新可能滞后 | ⭐⭐⭐⭐ |
| 方案A3 | 调整提示词降级 | 无需代码改动 | 功能完全缺失,用户体验极差 | ⭐ |

**最终选择: 方案A1 - 接入mermaid.js库**

#### 技术实现架构

**组件层级结构:**

```
ai-analysis-tools.tsx (父组件)
  └── MermaidRenderer.tsx (新建组件)
       ├── 检测代码块类型 (mermaid/markdown)
       ├── mermaid.js渲染引擎
       ├── 错误边界捕获
       └── 降级显示机制
```

**MermaidRenderer 组件设计:**

| 功能模块 | 职责 | 关键逻辑 |
|---------|------|---------|
| 代码块检测 | 识别Markdown中的Mermaid代码块 | 正则匹配` ```mermaid ... ``` ` |
| 渲染引擎 | 调用mermaid.js生成SVG | 异步render方法,返回SVG字符串 |
| 错误捕获 | 处理语法错误 | try-catch捕获,降级显示源代码 |
| 主题适配 | 跟随系统深色模式 | 读取next-themes状态,切换mermaid主题 |
| 性能优化 | 防止重复渲染 | useEffect依赖code变化时才重新渲染 |

#### 降级策略设计

```
Mermaid渲染流程
  ├── 尝试渲染
  │   ├── 成功 → 展示SVG图表
  │   └── 失败 → 错误捕获
  │       ├── 显示错误提示
  │       └── 降级显示源代码 (可复制)
  └── 提供手动复制功能
       └── "复制代码到Mermaid编辑器"按钮
```

#### 边界情况处理

| 场景 | 处理策略 | 用户反馈 |
|------|---------|---------|
| Mermaid语法错误 | 捕获异常,显示错误信息和源代码 | "图表渲染失败,显示源代码" |
| 图表过于复杂(节点>100) | 显示性能警告,提供缩放控制 | "图表较复杂,可能加载较慢" |
| 中文字符乱码 | 配置fontFamily支持中文 | 正常渲染中文标签 |
| 多个图表同时渲染 | 每个图表独立id,避免冲突 | 正常渲染多个图表 |
| 响应式布局 | SVG设置width:100%,自适应容器 | 图表自适应屏幕宽度 |

#### 依赖管理

**新增依赖:**
- `mermaid`: ^11.0.0 (核心渲染引擎)

**package.json 更新策略:**
- 添加到 dependencies (运行时需要)
- 无需peer dependencies (mermaid独立)

---

### 3.2 方案B: 统一模型配置 [P1]

#### 配置统一架构

**创建共享配置模块:**

文件路径: `src/lib/model-config.ts`

**配置结构设计:**

| 配置项 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| endpoint | string | API端点URL | https://api.deepseek.com/v1/chat/completions |
| defaultModel | string | 默认模型名称 | deepseek-chat |
| contextWindow | number | 上下文窗口大小 (tokens) | 32768 |
| costPer1kTokens | number | 千token计费价格(元) | 0.001 |
| supportedFeatures | string[] | 支持的功能特性 | ["streaming", "json_mode"] |

**统一配置原则:**

| Provider | 统一选择模型 | 选择理由 | 上下文窗口 |
|----------|-------------|---------|-----------|
| deepseek | deepseek-chat | 所有API已一致 | 32k tokens |
| qwen | **qwen-turbo** | 基础版,覆盖面广,成本低 | 8k tokens |
| doubao | **doubao-pro-4k** | 基础版,与chat/prd一致 | 4k tokens |
| custom | 用户指定 | 自定义场景,用户负责 | 不限 |

#### 迁移策略

**三个API路由统一引用:**

| API路由 | 当前配置位置 | 改造方式 | 兼容性 |
|---------|-------------|---------|--------|
| /api/analyze | 路由内硬编码 | 引入getModelConfig() | 向下兼容 |
| /api/chat | 路由内硬编码 | 引入getModelConfig() | 向下兼容 |
| /api/generate-prd | 路由内硬编码 | 引入getModelConfig() | 向下兼容 |

**配置加载流程:**

```
请求到达 → 解析model参数 → getModelConfig(model)
  ↓
返回配置对象
  ├── endpoint: API端点
  ├── defaultModel: 实际模型名
  └── 其他元数据
  ↓
构建AI请求 → 使用defaultModel
```

#### 扩展性设计

**支持环境变量覆盖:**

| 环境变量 | 优先级 | 用途 | 示例 |
|---------|-------|------|------|
| NEXT_PUBLIC_QWEN_MODEL | 高 | 覆盖qwen默认模型 | qwen-plus |
| NEXT_PUBLIC_DOUBAO_MODEL | 高 | 覆盖doubao默认模型 | doubao-pro-32k |
| MODEL_CONFIG_PATH | 中 | 外部配置文件路径 | /config/models.json |

**配置验证机制:**

| 验证项 | 验证规则 | 失败行为 |
|--------|---------|---------|
| 模型存在性 | 检查model是否在配置中 | 返回400错误,提示支持的模型列表 |
| endpoint格式 | URL格式校验 | 拒绝请求,记录日志 |
| 白名单校验 | 自定义API域名检查 | 返回安全错误 |

---

### 3.3 方案C: 增强错误处理 [P1]

#### 错误处理架构

**分层错误处理策略:**

```
上游AI API
  ↓ (错误发生)
后端错误解析层
  ├── 解析JSON错误体
  ├── 提取error.message
  ├── 状态码映射友好提示
  └── 构建结构化错误响应
  ↓
前端错误展示层
  ├── 主错误信息 (toast标题)
  ├── 详细错误 (toast description)
  └── 可选的错误代码 (开发模式)
```

#### 后端错误增强设计

**错误响应结构:**

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| error | string | 用户友好的错误描述 | "认证失败,请检查API Key" |
| detail | string | 上游详细错误信息 | "invalid api key: sk-xxx" |
| code | string | 错误代码 (便于日志追踪) | "AUTH_INVALID_KEY" |
| status | number | HTTP状态码 | 401 |
| suggestion | string | 解决建议 | "请在设置页面重新配置API Key" |

**状态码映射表:**

| HTTP状态码 | 错误类型 | 友好提示 | 解决建议 |
|-----------|---------|---------|---------|
| 400 | 请求格式错误 | 请求参数有误 | 检查输入内容格式 |
| 401 | 认证失败 | API Key无效或已过期 | 请在设置页面重新配置 |
| 403 | 权限不足 | 账号无权访问该模型 | 确认账号权限或更换模型 |
| 404 | 资源不存在 | 模型不可用 | 检查模型配置是否正确 |
| 429 | 请求限流 | 请求过于频繁 | 请等待60秒后重试 |
| 402 | 账户欠费 | 账户余额不足 | 请充值后继续使用 |
| 500 | 服务器错误 | AI服务暂时不可用 | 请稍后重试 |
| 502/503/504 | 网关错误 | 服务连接超时 | 检查网络连接后重试 |

#### 前端错误展示设计

**Toast提示层级:**

| 错误严重度 | Toast类型 | 显示时长 | 交互 |
|-----------|---------|---------|------|
| 高 (认证/权限) | error (红色) | 10秒 | 可点击跳转设置 |
| 中 (限流/超时) | warning (黄色) | 5秒 | 手动关闭 |
| 低 (格式错误) | info (蓝色) | 3秒 | 自动消失 |

**错误解析逻辑:**

```
fetch响应
  ↓
if (!response.ok)
  ├── 尝试解析JSON错误体
  │   ├── 成功 → 提取error/detail/suggestion
  │   └── 失败 → 使用状态码映射
  └── 显示Toast
      ├── 标题: error字段
      ├── 描述: suggestion字段
      └── 详情: detail字段 (开发模式)
```

#### 错误日志记录

**日志级别策略:**

| 日志级别 | 触发条件 | 记录内容 | 用途 |
|---------|---------|---------|------|
| ERROR | 5xx服务器错误 | 完整请求/响应/堆栈 | 问题定位 |
| WARN | 4xx客户端错误 | 请求参数/错误信息 | 异常监控 |
| INFO | 限流/重试 | 状态码/重试次数 | 性能分析 |

---

### 3.4 方案D: 补充端到端测试 [P2]

#### 测试架构设计

**测试文件组织结构:**

```
src/__tests__/
├── api/
│   ├── analyze.test.ts           # analyze API单元测试
│   ├── chat.test.ts               # chat API单元测试
│   ├── generate-prd.test.ts       # generate-prd API单元测试
│   └── shared/
│       ├── model-config.test.ts   # 模型配置测试
│       └── error-handler.test.ts  # 错误处理测试
├── components/
│   ├── ai-analysis-tools.test.tsx # AI分析组件测试
│   └── mermaid-renderer.test.tsx  # Mermaid渲染组件测试
└── integration/
    └── ai-analysis-e2e.test.ts    # 端到端集成测试
```

#### API测试设计

**analyze API测试覆盖矩阵:**

| 测试维度 | 测试用例 | Mock策略 | 验证点 |
|---------|---------|---------|--------|
| 成功场景 | 四种分析类型正常返回 | Mock AI返回结构化内容 | 响应200,content字段存在 |
| 参数校验 | 缺少prdContent/apiKey | 无需Mock | 返回400,错误提示准确 |
| 模型配置 | 三种模型正确映射 | Mock fetch | 实际调用正确的模型名称 |
| 错误处理 | 401/403/404/429各类错误 | Mock返回错误响应 | 错误信息正确映射 |
| 白名单校验 | 自定义API域名验证 | 无需Mock | 允许/拒绝逻辑正确 |
| 超时处理 | 网络超时场景 | Mock延迟超过阈值 | 返回超时错误 |

**测试用例结构:**

每个分析类型(optimize/score/competitor/diagram)都需要以下测试:

| 用例类型 | 输入 | 预期输出 | 断言点 |
|---------|------|---------|--------|
| 正常流程 | 完整PRD内容 | 结构化分析结果 | status=200, content非空 |
| 空内容 | prdContent="" | 400错误 | error="PRD内容不能为空" |
| 无API Key | apiKey="" | 400错误 | error="请先配置 API Key" |
| AI返回错误 | Mock 401响应 | 401错误 | error包含"认证失败" |

#### 前端组件测试设计

**ai-analysis-tools.tsx 测试场景:**

| 测试场景 | 操作步骤 | 验证点 |
|---------|---------|--------|
| 初始状态 | 渲染组件 | 按钮显示"AI 分析",下拉菜单包含4个选项 |
| 点击分析 | 点击optimize选项 | loading状态切换,Sheet打开 |
| 成功响应 | Mock返回成功 | 显示Markdown内容,loading消失 |
| 错误响应 | Mock返回401 | 显示toast错误,loading消失 |
| 无内容禁用 | prdContent为空 | 按钮disabled,点击无响应 |
| 标签页切换 | 切换到score标签 | activeTab更新,内容切换 |

**MermaidRenderer 测试场景:**

| 测试场景 | 输入 | 预期行为 | 验证方式 |
|---------|------|---------|---------|
| 合法Mermaid代码 | `graph TD; A-->B` | 渲染SVG图表 | 检查DOM包含<svg>元素 |
| 语法错误代码 | `graph TD; A->>B` | 显示错误提示和源代码 | 检查错误文案存在 |
| 空代码 | `""` | 显示占位提示 | 检查占位文案 |
| 多图表 | 多个mermaid块 | 每个独立渲染 | 检查SVG数量 |
| 主题切换 | 切换深色模式 | Mermaid主题同步 | 检查theme属性 |

#### 集成测试设计

**端到端流程测试:**

```
用户操作流 → 前端组件 → API路由 → Mock AI → 响应返回 → UI更新
```

| 集成场景 | 测试流程 | Mock策略 | 验证点 |
|---------|---------|---------|--------|
| 完整分析流程 | 点击分析→等待→查看结果 | Mock /api/analyze返回 | Sheet打开,内容正确渲染 |
| 错误处理流程 | 触发API错误→查看提示 | Mock返回401 | Toast显示友好错误 |
| Mermaid渲染流程 | 生成图表→查看渲染 | Mock返回Mermaid代码 | SVG正确渲染 |

#### 测试工具配置

**Mock策略:**

| Mock对象 | 工具 | 用途 | 示例 |
|---------|------|------|------|
| AI API请求 | jest.fn() | 模拟fetch响应 | Mock返回结构化JSON |
| Mermaid渲染 | jest.mock('mermaid') | 模拟渲染引擎 | Mock render方法返回SVG |
| Toast通知 | jest.mock('sonner') | 验证错误提示 | 检查toast.error调用 |

**测试覆盖率目标:**

| 代码类型 | 行覆盖率 | 分支覆盖率 | 函数覆盖率 |
|---------|---------|-----------|-----------|
| API路由 | ≥ 90% | ≥ 85% | 100% |
| 组件代码 | ≥ 85% | ≥ 80% | ≥ 90% |
| 工具函数 | 100% | 100% | 100% |

---

## 四、实施计划

### 4.1 优先级排序

| 阶段 | 任务 | 优先级 | 预估工时 | 依赖 |
|------|------|--------|---------|------|
| 阶段1 | Mermaid图表渲染 | P0 | 6小时 | 无 |
| 阶段2 | 统一模型配置 | P1 | 3小时 | 无 |
| 阶段2 | 增强错误处理 | P1 | 4小时 | 无 |
| 阶段3 | 补充端到端测试 | P2 | 8小时 | 阶段1和2完成 |

### 4.2 阶段一: Mermaid图表渲染 [6小时]

#### 任务分解

| 子任务 | 工作内容 | 产出物 | 工时 |
|--------|---------|--------|------|
| 1.1 依赖安装 | 安装mermaid依赖包 | package.json更新 | 0.5h |
| 1.2 组件开发 | 创建MermaidRenderer组件 | src/components/mermaid-renderer.tsx | 2h |
| 1.3 集成组件 | 在ai-analysis-tools中集成 | ai-analysis-tools.tsx更新 | 1h |
| 1.4 错误处理 | 实现降级机制 | 错误边界和降级UI | 1h |
| 1.5 样式适配 | 主题和响应式适配 | CSS样式文件 | 1h |
| 1.6 本地测试 | 手动测试四种图表类型 | 测试报告 | 0.5h |

#### MermaidRenderer 组件核心职责

| 功能模块 | 输入 | 输出 | 异常处理 |
|---------|------|------|---------|
| 代码块解析 | Markdown文本 | Mermaid代码块数组 | 无Mermaid块返回空数组 |
| 渲染引擎 | Mermaid代码字符串 | SVG DOM元素 | 语法错误捕获,降级显示 |
| 主题管理 | 系统主题状态(dark/light) | 对应的Mermaid主题 | 默认neutral主题 |
| 错误降级 | 渲染错误 | 显示源代码+复制按钮 | 显示错误提示文案 |

#### 集成点修改

**ai-analysis-tools.tsx 改造:**

| 改造位置 | 原实现 | 新实现 | 理由 |
|---------|-------|--------|------|
| 依赖导入 | ReactMarkdown | MermaidRenderer + ReactMarkdown | 支持Mermaid |
| 渲染逻辑 | 直接渲染Markdown | 根据type判断渲染组件 | diagram类型使用MermaidRenderer |
| 错误边界 | 无 | ErrorBoundary包裹 | 防止渲染崩溃 |

**条件渲染逻辑:**

```
results[type] 内容判断
  ├── type === 'diagram'
  │   └── 使用 MermaidRenderer
  └── 其他类型
      └── 使用 ReactMarkdown
```

---

### 4.3 阶段二: 统一配置与错误处理 [7小时]

#### 任务2.1: 统一模型配置 [3小时]

| 子任务 | 工作内容 | 产出物 | 工时 |
|--------|---------|--------|------|
| 2.1.1 创建配置模块 | 开发model-config.ts | src/lib/model-config.ts | 1h |
| 2.1.2 迁移analyze API | 引入配置,移除硬编码 | route.ts更新 | 0.5h |
| 2.1.3 迁移chat API | 引入配置,移除硬编码 | route.ts更新 | 0.5h |
| 2.1.4 迁移generate-prd API | 引入配置,移除硬编码 | route.ts更新 | 0.5h |
| 2.1.5 验证一致性 | 对比三个API配置 | 配置一致性报告 | 0.5h |

**model-config.ts 模块接口:**

| 导出函数 | 签名 | 返回值 | 用途 |
|---------|------|--------|------|
| getModelConfig | (model: string) => ModelConfig | 模型配置对象 | 获取完整配置 |
| getEndpoint | (model: string) => string | API端点URL | 仅获取端点 |
| getDefaultModel | (model: string) => string | 模型名称 | 仅获取模型名 |
| getSupportedModels | () => string[] | 模型列表 | 获取所有支持的模型 |

#### 任务2.2: 增强错误处理 [4小时]

| 子任务 | 工作内容 | 产出物 | 工时 |
|--------|---------|--------|------|
| 2.2.1 创建错误映射表 | 定义状态码→友好提示 | error-mapper.ts | 1h |
| 2.2.2 后端错误解析 | 增强三个API错误处理 | route.ts更新 | 1.5h |
| 2.2.3 前端错误展示 | 优化Toast显示逻辑 | ai-analysis-tools.tsx更新 | 1h |
| 2.2.4 错误日志记录 | 添加结构化日志 | 日志配置 | 0.5h |

**错误响应结构标准化:**

所有API路由统一返回以下格式:

| 字段 | 必填 | 类型 | 说明 |
|------|------|------|------|
| error | 是 | string | 用户友好错误描述 |
| detail | 否 | string | 详细错误信息(开发模式) |
| code | 否 | string | 错误代码 |
| suggestion | 否 | string | 解决建议 |

---

### 4.4 阶段三: 测试补充 [8小时]

#### 任务3.1: API测试 [3小时]

| 子任务 | 工作内容 | 产出物 | 工时 |
|--------|---------|--------|------|
| 3.1.1 analyze API测试 | 编写完整测试用例 | analyze.test.ts | 1h |
| 3.1.2 chat API测试 | 编写完整测试用例 | chat.test.ts | 1h |
| 3.1.3 generate-prd测试 | 编写完整测试用例 | generate-prd.test.ts | 1h |

**每个API测试用例集:**

| 用例组 | 用例数 | 覆盖场景 |
|--------|--------|---------|
| 成功场景 | 4个 | 每种类型/阶段正常返回 |
| 参数校验 | 6个 | 缺少必填参数,参数格式错误 |
| 模型配置 | 3个 | deepseek/qwen/doubao配置正确 |
| 错误处理 | 8个 | 401/403/404/429/500等错误 |
| 白名单 | 5个 | 允许/拒绝不同域名 |

#### 任务3.2: 组件测试 [3小时]

| 子任务 | 工作内容 | 产出物 | 工时 |
|--------|---------|--------|------|
| 3.2.1 ai-analysis-tools测试 | 组件状态流转测试 | ai-analysis-tools.test.tsx | 1.5h |
| 3.2.2 MermaidRenderer测试 | 渲染成功/失败测试 | mermaid-renderer.test.tsx | 1.5h |

**组件测试用例集:**

| 组件 | 用例组 | 用例数 | 关键验证点 |
|------|--------|--------|-----------|
| ai-analysis-tools | 初始化 | 2个 | 按钮状态,菜单选项 |
| ai-analysis-tools | 交互 | 4个 | 点击,loading,结果显示 |
| ai-analysis-tools | 错误 | 3个 | Toast提示,错误状态 |
| MermaidRenderer | 渲染 | 5个 | SVG生成,错误降级 |
| MermaidRenderer | 主题 | 2个 | 深色/浅色模式 |

#### 任务3.3: 集成测试 [2小时]

| 子任务 | 工作内容 | 产出物 | 工时 |
|--------|---------|--------|------|
| 3.3.1 端到端流程 | 完整用户流程测试 | ai-analysis-e2e.test.ts | 1.5h |
| 3.3.2 覆盖率报告 | 生成并分析覆盖率 | coverage报告 | 0.5h |

**端到端测试场景:**

| 测试流程 | 步骤 | 验证点 | Mock策略 |
|---------|------|--------|---------|
| 完整分析流程 | 打开→选择→等待→查看 | UI状态正确,内容渲染 | Mock API成功响应 |
| 图表渲染流程 | 生成diagram→渲染Mermaid | SVG存在,可交互 | Mock Mermaid代码 |
| 错误处理流程 | 触发错误→查看提示 | Toast内容准确 | Mock API错误响应 |

---

## 五、验收标准

### 5.1 功能验收

#### Mermaid渲染功能

| 验收项 | 验收标准 | 测试方法 |
|--------|---------|---------|
| 架构图渲染 | 点击"生成图表",选择架构图,显示SVG可视化图表 | 手动测试 + 自动化测试 |
| 流程图渲染 | 流程图Mermaid代码正确渲染为图表 | 单元测试 |
| ER图渲染 | ER图关系正确展示,实体连线清晰 | 集成测试 |
| 错误降级 | 语法错误时显示源代码和"复制"按钮 | 错误注入测试 |
| 主题适配 | 切换深色模式,图表主题同步变化 | 主题切换测试 |
| 响应式布局 | 图表在不同屏幕宽度下自适应 | 视口测试 |

#### 模型配置统一

| 验收项 | 验收标准 | 测试方法 |
|--------|---------|---------|
| analyze使用qwen-turbo | analyze API调用时实际使用qwen-turbo | API Mock验证 |
| analyze使用doubao-pro-4k | analyze API调用时实际使用doubao-pro-4k | API Mock验证 |
| 三API配置一致 | analyze/chat/generate-prd使用相同模型映射 | 配置对比测试 |
| 配置可扩展 | 可通过环境变量覆盖默认模型 | 环境变量测试 |

#### 错误处理增强

| 验收项 | 验收标准 | 测试方法 |
|--------|---------|---------|
| 401错误提示 | 显示"认证失败,请检查API Key" | Mock 401响应 |
| 429错误提示 | 显示"请求过于频繁,请X秒后重试" | Mock 429响应 |
| 详细信息显示 | Toast description包含解决建议 | UI测试 |
| 错误日志记录 | 服务端日志包含完整请求/响应 | 日志验证 |

### 5.2 测试覆盖验收

| 验收项 | 目标值 | 测试方法 |
|--------|--------|---------|
| API路由行覆盖率 | ≥ 90% | jest --coverage |
| 组件行覆盖率 | ≥ 85% | jest --coverage |
| 分支覆盖率 | ≥ 80% | coverage报告 |
| 端到端测试 | 核心流程100%覆盖 | e2e测试执行 |

### 5.3 性能验收

| 验收项 | 目标值 | 测试方法 |
|--------|--------|---------|
| Mermaid渲染时间 | < 500ms (普通图表) | Performance API |
| Bundle体积增长 | < 300KB (含mermaid) | webpack-bundle-analyzer |
| API响应时间 | 无回归 (与优化前持平) | 性能对比测试 |

### 5.4 兼容性验收

| 验收项 | 验收标准 | 测试方法 |
|--------|---------|---------|
| 向下兼容 | 现有功能无破坏性变更 | 回归测试 |
| 浏览器兼容 | Chrome/Firefox/Safari/Edge正常渲染 | 跨浏览器测试 |
| 移动端适配 | 响应式布局在移动设备正常展示 | 移动设备测试 |

---

## 六、风险与缓解

### 6.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| Mermaid渲染性能问题 | 复杂图表卡顿 | 中 | 1. 限制节点数量上限<br>2. 懒加载策略<br>3. 提供"查看源代码"降级选项 |
| Bundle体积增长 | 首屏加载变慢 | 低 | 1. 动态导入mermaid<br>2. Tree-shaking优化<br>3. 监控bundle分析报告 |
| 模型配置迁移破坏现有功能 | 用户请求失败 | 低 | 1. 灰度发布<br>2. 提供环境变量回退机制<br>3. 充分回归测试 |
| 测试Mock不准确 | 测试通过但生产失败 | 中 | 1. 使用真实API响应录制<br>2. 定期验证Mock数据<br>3. 补充集成测试 |

### 6.2 业务风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 用户不习惯新错误提示 | 用户困惑 | 低 | 1. 错误提示文案用户测试<br>2. 提供帮助文档链接<br>3. 保留详细错误信息(开发模式) |
| Mermaid图表中文乱码 | 用户体验差 | 中 | 1. 配置中文字体<br>2. 测试包含中文的图表<br>3. 提供字体回退方案 |
| 模型切换导致成本增加 | (无,统一为基础版) | - | - |
| 测试覆盖不足导致回归 | 功能异常 | 中 | 1. 严格执行测试计划<br>2. Code Review关注测试<br>3. 自动化测试门禁 |

### 6.3 时间风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| Mermaid组件开发超时 | 延期交付 | 中 | 1. 预留20%缓冲时间<br>2. 降级为方案A3(仅提示)<br>3. 分阶段交付 |
| 测试编写超时 | 测试覆盖不足 | 中 | 1. 优先覆盖核心流程<br>2. 后续迭代补充<br>3. 使用测试生成工具 |

---

## 七、后续优化方向

### 7.1 短期优化 (1-2周)

| 优化项 | 价值 | 复杂度 | 优先级 |
|--------|------|--------|--------|
| Mermaid图表导出功能 | 用户可保存图表为PNG/SVG | 低 | 中 |
| 图表编辑功能 | 用户可在线调整Mermaid代码 | 中 | 低 |
| 分析结果缓存 | 减少重复分析请求 | 低 | 高 |
| 批量分析功能 | 同时生成多种分析报告 | 中 | 中 |

### 7.2 中期优化 (1-2月)

| 优化项 | 价值 | 复杂度 | 依赖 |
|--------|------|--------|------|
| 分析历史记录 | 查看历史分析结果 | 中 | 需数据库支持 |
| 自定义分析维度 | 用户定义分析角度 | 高 | 需提示词工程 |
| 分析结果对比 | 对比不同版本PRD分析差异 | 中 | 需历史记录 |
| AI分析质量评估 | 评估分析结果质量 | 高 | 需评估模型 |

### 7.3 长期优化 (3月+)

| 优化项 | 价值 | 战略意义 |
|--------|------|---------|
| 多模型对比分析 | 使用不同模型分析,对比结果 | 提升分析准确性 |
| 智能分析推荐 | 根据PRD类型推荐最佳分析组合 | 提升用户体验 |
| 分析模板市场 | 用户共享/下载分析模板 | 构建生态 |
| 实时协作分析 | 多人同时查看/讨论分析结果 | 团队协作能力 |

---

## 八、关键决策记录

| 决策点 | 选项 | 最终选择 | 理由 |
|--------|------|---------|------|
| Mermaid渲染方案 | A1:mermaid.js / A2:react-mermaid / A3:降级提示 | A1 | 功能完整,可控性强,社区活跃 |
| 模型统一方向 | 统一为plus / 统一为turbo / 保持现状 | 统一为turbo | 覆盖面广,成本低,与现有一致 |
| 错误处理策略 | 仅状态码 / 详细错误 / 结构化错误 | 结构化错误 | 可读性强,便于定位,用户友好 |
| 测试优先级 | API优先 / 组件优先 / 同步进行 | API优先 | 核心逻辑,影响范围大 |
| 发布策略 | 一次性发布 / 分阶段发布 | 分阶段发布 | 降低风险,逐步验证 |

---

## 九、附录

### 9.1 依赖变更

**新增运行时依赖:**

| 依赖包 | 版本 | 用途 | Bundle增量 |
|--------|------|------|-----------|
| mermaid | ^11.0.0 | Mermaid图表渲染 | ~200KB gzipped |

**现有依赖无需变更**

### 9.2 配置文件变更

**package.json:**
- dependencies新增mermaid

**jest.config.js:**
- 无需变更 (测试文件自动发现)

**tsconfig.json:**
- 无需变更

### 9.3 环境变量 (可选)

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| NEXT_PUBLIC_QWEN_MODEL | qwen-turbo | 覆盖qwen默认模型 |
| NEXT_PUBLIC_DOUBAO_MODEL | doubao-pro-4k | 覆盖doubao默认模型 |
| ENABLE_MERMAID_DEBUG | false | 开启Mermaid调试日志 |

### 9.4 数据结构

**错误响应标准格式:**

```
{
  error: string          // 用户友好错误描述
  detail?: string        // 详细错误信息
  code?: string          // 错误代码
  suggestion?: string    // 解决建议
}
```

**模型配置结构:**

```
{
  endpoint: string           // API端点
  defaultModel: string       // 默认模型名
  contextWindow: number      // 上下文窗口
  costPer1kTokens: number    // 计费价格
  supportedFeatures: string[] // 支持特性
}
```

### 9.5 Mermaid主题配置

**支持的主题:**

| 主题名 | 使用场景 | 颜色方案 |
|--------|---------|---------|
| default | 浅色模式默认 | 蓝色系 |
| dark | 深色模式 | 深灰+亮色文字 |
| neutral | 中性主题 | 灰色系 |
| forest | 自然风格 | 绿色系 |

**配置策略:**
- 系统浅色模式 → default主题
- 系统深色模式 → dark主题
- 用户可在设置中自定义
